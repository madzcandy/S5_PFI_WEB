<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Images Manager</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
        <link rel="stylesheet"
            href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
        <link rel="stylesheet" href="css/site.css">
        <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
        <link rel="manifest" href="images/site.webmanifest">
        <link rel="icon" href="favicon.ico">
    </head>

    <body>

        <div class="mainContainer">
            <div class="headerPanel">
                <div class="headerLayout">
                    <div id="Title">
                        <img src="images/camera.png" alt="" data-toggle="tooltip" class="favicon" title="Gestionnaire d'images" id="Title_Logo">
                        <img src="images/Title.png" alt="" data-toggle="tooltip">
                    </div>

                    <span id="userList"></span>

                    <input type="text" id="search_input"  placeholder="Recherche par mots-clés">
                    <span class="cmd fa fa-search" id="searchCmd" title="Rechercher" data-toggle="tooltip"></span>


                    <div id="menuUser">
                        <div class="menu">
                            <span>
                                <span class="cmd fa fa-user-plus" id="registerCmd" title="S'inscrire"
                                data-toggle="tooltip"></span>

                                <span class="cmd fa fa-user-pen" id="editProfileCmd" title="Modifier le profil"
                                data-toggle="tooltip"></span>

                                <span class="cmd fa fa-envelope" id="mailCmd" title="Vérification de courriel"
                                data-toggle="tooltip"></span>

                                <span class="cmd fa fa-right-to-bracket" id="loginCmd" title="Connexion"
                                data-toggle="tooltip"></span>

                                <span class="cmd fa fa-right-from-bracket" id="logoutCmd" title="Déconnexion"
                                data-toggle="tooltip"></span>

                                <span class="cmd fa fa-user-times" id="deleteAccountCmd" title="Supprimer le compte"
                                data-toggle="tooltip"></span>
                                
                            </span>
                            <span>
                                <span class="cmd fa fa-plus-square" id="newImageCmd" title="Ajouter un image"
                                    data-toggle="tooltip"></span>
                                <span class="cmd fa fa-sort-amount-desc" id="sort" title="Trier"
                                data-toggle="tooltip"></span>
                            </span>
                            <div id="loginUser"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="scrollContainer">
                <div id="imagesList">
                    <!-- filled programmatically-->
                </div>
            </div>
            <div>
                <div id="imageDlg">
                    <form id="imageForm">
                        <input type="hidden" id="Id_input" value="0">
                        <input type="hidden" id="date_input" value="0">
                        <input type="hidden" id="GUID_input" value="">
                        <input type="hidden" id="image_userId_input" value="">

                        <label for="title_input">Titre</label>
                        <input type="text" id="title_input" class="form-control">
                        <div style="color: red;" id="errorTitle"></div>

                        <label for="decription_input">Description</label>
                        <textarea id="description_input" class="form-control"></textarea>
                        <div style="color: red;" id="errorDescription"></div>

                        <label for="image">Image</label>
                        <div id='image' class='ImageUploader' defaultImage='images/No_Image.png'
                            waitingImage='images/writing.gif'>
                        </div>
                        <div class="note">Cliquez-Déposez une image</div>
                        <div> <input type="checkbox" id="partager" value=""><label for="partager">Partager</label></div>
                    </form>
                </div>


                <div id="imageDetailsDlg">
                    <div>
                        <label for="creator_details_input">Créateur</label>
                        <span id="creator_details_input"></span>
                    </div>   
                    <div>
                        <label for="title_details_input">Titre</label>
                        <span id="title_details_input"></span>
                    </div>
                    <div>
                        <label for="decription_details_input">Description</label>
                        <span id="description_details_input"></span>
                    </div>
                    <div>
                        <label for="date_details_input">Date</label>
                        <span id="date_details_input"></span>
                    </div>
                    <div>
                        <label for="image_details">Image</label>
                        <span id='image_details'></span>
                    </div>            
                </div>


                <div id="registerDlg">
                    <form id="registerForm">
                        <input type="hidden" id="profile_userId_input" value="0">
                        <input type="hidden" id="profile_userCode_input">
                        <input type="hidden" id="profile_avatarUrl_input">
                        <input type="hidden" id="profile_avatarGUID_input">

                        <label for="profile_user_input">Nom d'usager</label>
                        <input type="text" id="profile_user_input" class="form-control" required>
                        <div style="color: red;" id="errorUsername"></div>
                    
                        <label for="profile_email_input">Courriel</label>
                        <input id="profile_email_input" class="form-control Email" required patternMessage="Courriel invalide">
                        <div style="color: red;" id="errorEmail"></div>

                        <label for="profile_mdp_input">Mot de passe</label>
                        <input type="password" id="profile_mdp_input" class="form-control MatchedPassword" matchedPasswordId="profile_cmdp_input" required>

                        <label for="profile_cmdp_input">Confirmation</label>
                        <input type="password" id="profile_cmdp_input" class="form-control" required>

                        <div style="color: red;" id="errorMdp"></div>

                        <label for="avatarImage">Avatar</label>
                        <div id='avatarImage' class='ImageUploader' defaultImage='images/No_Avatar.png'
                            waitingImage='images/writing.gif'>

                        <div style="color: red;" id="errorAvatar"></div>
                        
                        </div>
                        <div class="note">Cliquez-Déposez votre avatar</div>
                    </form>
                </div>

                <div id="loginDlg">
                    <form id="loginForm">
                        <label for="log_email_input">Courriel</label>
                        <input id="log_email_input" class="form-control" required>

                        <label for="log_mdp_input">Mot de passe</label>
                        <input type="password" id="log_mdp_input" class="form-control" required>

                        <input type="checkbox" id="log_souvenir">Se souvenir de moi</div>
                    </form>
                </div>

                <div id="mailDlg">
                    <form id="mailForm">
                        Consultez votre boite de courriel pour connaître votre code
                        de vérification et inscrivez-le ci-dessous

                        <label for="mailCode_input">Code de vérification</label>
                        <input id="mailCode_input" class="form-control" required>
                    </form>
                </div>

                <div id="deleteAccountDlg">
                    <div style="margin: 20px 0px;">Voulez-vous vraiment supprimer votre compte? </div>
                    <div>Cela mènera à la suppression de toutes les images publié.</div>
                </div>

                <div id="confirmDeleteDlg">
                    <span id="confirmationMessage"></span>
                </div>
                <div id="errorDlg">
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="js/customValidation.js"></script>
        <script src="js/imageUploader.js"></script>
        <script src="js/api.js"></script>
        <script src="js/formValidator.js"></script>
        <script src="js/date.js"></script>
        <script defer>
            const periodicRefreshPeriod = 15;
            let holdCheckETag = false;
            let currentETag = "";
            let createMode = true;
            let registerMode = true;
            let searchCategory = "";
            let searchTitle = "";
            let hideSearchBar = true;
            let imageIdToDelete = 0; // used by confirmDeleteDlg
            let selectedCategory = "";
            let imagesCount = 20;
            let appendCount = 3;
            let previousScrollPosition = 0;
            let appendMode = false;
            let sort = "desc";
            let textSearch = "";
            let userSelectSearch="";
            let registerEmail="";
            let registerPassword="";

            init_UI();
            HEAD(checkETag, error);
            setInterval(() => { HEAD(checkETag, error) }, periodicRefreshPeriod * 1000);

            function checkETag(ETag) {
                if (!holdCheckETag && ETag != currentETag) {
                    currentETag = ETag;
                    getImagesList();
                }
            }

            function successGetListUser(users, ETag){
                function insertSearchUser(user) {                                                   
                    return(`<option value='${user.Id}'>${user.Name}</option>`)
                }
                $("#userList").empty(); 
                let userLogged = getUserLogged();                                       
                let selectinfo ="<select id='userSearch'><option value=''>Tous les Usagers</option>";

                if(userLogged != undefined)
                {
                    selectinfo = selectinfo + "<option value='" + userLogged.Id + "'>Mes images</option>";
                }
                
                for (let user of users) {
                    if(userLogged == undefined || user.Id != userLogged.Id)
                    {
                        selectinfo=selectinfo+insertSearchUser(user);
                    }
                }
                selectinfo=selectinfo+"</select>";                
                $("#userList").append(selectinfo);                          
            }

            
            function getListUser() {  
                GET_LIST_USER(successGetListUser, error);
            }

            function getImagesList(refresh = true) {
                //alert("getIMAGE"+refresh);
                appendMode = !refresh;
                function prepareQueryString() {
                    let queryString = "";
                    let userId = 0;
                    let user =getUserLogged();

                    if(user != undefined){
                        userId=user.Id;
                    }

                    if (appendMode) {
                        queryString = `?loginid=`+ userId + `&UserId=`+ userSelectSearch+ `&keywords=` + textSearch + `&sort=Date,` + sort + `&offset=${Math.trunc(imagesCount / appendCount)}&limit=${appendCount}`;
                        imagesCount += appendCount;
                    } else {
                        queryString = `?loginid=`+ userId + `&UserId=`+ userSelectSearch+ `&keywords=` + textSearch + `&sort=Date,` + sort + `&offset=${0}&limit=${imagesCount}`;
                    }
                    console.log(queryString);
                    return queryString;
                }
                GET_ALL(refreshimagesList, error, prepareQueryString());
            }
            function refreshimagesList(images, ETag) {
                function insertIntoImageList(image) {                                                          
                    let imageUser = image.User.AvatarURL;                     
                    let iconImg = '';
                    var user = getUserLogged();

                    if(user != null && image.UserId == user.Id && image.Shared)
                        iconImg = `<img src="images/shared.png" alt="" data-toggle="tooltip" class="favicon" title="Votre image partagée">`;                     
                    else
                        if(user == null ||  image.UserId != user.Id)
                            iconImg = `<img id="loginLogo" src="${imageUser}" alt="" data-toggle="tooltip" class="favicon" title="${image.User.Name}">`;                           
                        

                    let buttImg = '';

                    if(user != null && image.UserId == user.Id) {
                        buttImg = 
                        `<div    class="cmd editCmd  fa fa-pencil-square"
                                imageid="${image.Id}"
                                title="Editer ${image.Title}"
                                data-toggle="tooltip">
                        </div>
                        <div    class="cmd deleteCmd fa fa-window-close"
                                imageid="${image.Id}"
                                title="Effacer ${image.Title}"
                                data-toggle="tooltip">
                        </div>
                        <div    class="cmd detailsCmd fa fa-eye"
                                imageid="${image.Id}"
                                title="Voir ${image.Title}"
                                data-toggle="tooltip">
                        </div>`
                    }  
                    else
                    {
                        buttImg = 
                            `<div    class="cmd detailsCmd fa fa-eye"
                                    imageid="${image.Id}"
                                    title="Voir ${image.Title}"
                                    data-toggle="tooltip">
                            </div>`
                    }



                    $("#imagesList").append(
                        $(`
                            <div class='imageLayout'>
                                <div class='imageHeader'>
                                    <div class="imageTitle">${image.Title}</div>
                                    ${buttImg}
                                </div>
                                <div  title="Voir ${image.Title}"  data-toggle="tooltip">
                                    <div class='image detailsCmd' imageid="${image.Id}" style="background-image:url('${image.ThumbnailURL}')">
                                        ${iconImg}
                                    </div>
                                </div>
                                <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                            </div>
                        `)
                    );
                }
                currentETag = ETag;
                previousScrollPosition = $(".scrollContainer").scrollTop();
                if (!appendMode) $("#imagesList").empty();

                if (appendMode && images.length == 0)
                    imagesCount -= appendCount;

                for (let image of images) {
                    insertIntoImageList(image);
                }

                $(".scrollContainer").scrollTop(previousScrollPosition);
                $(".editCmd").off();
                $(".deleteCmd").off();
                $(".showMore").off();
                $(".editCmd").click(e => { editimage(e) });
                $(".detailsCmd").click(e => { detailsimage(e) });
                $(".deleteCmd").click(e => { deleteimage(e) });

                $('[data-toggle="tooltip"]').tooltip();
            }

            function error(status) {
                let errorMessage = "";
                switch (status) {
                    case 0:
                        errorMessage = "Le service ne répond pas";
                        break;
                    case 401:
                        errorMessage = "Requête non autorisée";
                        break;
                    case 400:
                    case 422:
                        errorMessage = "Requête invalide";
                        break;
                    case 404:
                        errorMessage = "Service ou données introuvables";
                        break;
                    case 409:
                        errorMessage = "Conflits de données: Hyperlien existe déjà";
                        break;
                    case 500:
                        errorMessage = "Erreur interne du service";
                        break;
                    default:
                        errorMessage = "Une erreur est survenue";
                        break;
                }
                $("#errorMessage").text(errorMessage);
                $("#errorDlg").dialog('open');
            }

            function registerCmd() {
                holdCheckETag = true;
                registerMode = true;
                var user = getUserLogged();

                //Reset from data
                $("#profile_userId_input").val(0);
                $("#profile_userCode_input").val("");
                $("#profile_avatarUrl_input").val("");
                $("#profile_avatarGUID_input").val("");

                $("#profile_user_input").val("");
                $("#profile_email_input").val("");
                $('label[for="profile_mdp_input"]').text("Mot de passe")
                $("#profile_mdp_input").val("");
                $("#profile_cmdp_input").val("");
                ImageUploader.resetImage('avatarImage');

                $("#errorMdp").html("");
                $("#errorEmail").html("");
                $("#errorUsername").html("");
                $("#errorAvatar").html("");
                
                $("#registerDlg").dialog('option', 'title', "Création de compte");
                $("#registerDlgOkBtn").text("Créer");
                $("#registerDlg").dialog('open');
            }
            function editProfileCmd() {
                holdCheckETag = true;
                registerMode = false;
                var user = getUserLogged();
                console.log(user);
                if(user == null){
                    $("#errorMessage").text("Vous n'êtes pas connecté");
                    $("#errorDlg").dialog('open');
                }
                else{
                    //Set form data
                    $("#profile_userId_input").val(user.Id);
                    $("#profile_userCode_input").val(user.VerifyCode);
                    $("#profile_avatarUrl_input").val(user.AvatarURL);
                    $("#profile_avatarGUID_input").val(user.AvatarGUID);

                    $("#profile_user_input").val(user.Name);
                    $("#profile_email_input").val(user.Email);
                    $('label[for="profile_mdp_input"]').text("Nouveau mot de passe")
                    $("#profile_mdp_input").val("");
                    $("#profile_cmdp_input").val("");
                    ImageUploader.setImage('avatarImage', user.AvatarURL);
                    
                    // ImageUploader.resetImage('avatarImage');//To delete after the token works
                    $("#registerDlg").dialog('option', 'title', "Modification de compte");
                    $("#registerDlgOkBtn").text("Modifier");
                    $("#registerDlg").dialog('open');
                }
            }
            function profileInfoFromForm() {
                let registerinfo = {
                        // Id: $("#profile_userId_input").val(),
                        Id: parseInt($("#profile_userId_input").val()),
                        Name: ($("#profile_user_input").val()),
                        Email: $("#profile_email_input").val(),
                        Password: $("#profile_mdp_input").val(),
                        ImageData: ImageUploader.getImageData('avatarImage'),
                        AvatarGUID: $("#profile_avatarGUID_input").val(),
                        // AvatarURL: $("#profile_userCode_input").val(),
                        VerifyCode: $("#profile_userCode_input").val(),
                };
                return registerinfo;
            }

            function mailCmd() {
                holdCheckETag = true;
                createMode = true;
                $("#mailDlg").dialog('option', 'title', "Vérification de courriel");
                $("#mailDlgOkBtn").text("Envoyer");
                $("#mailDlg").dialog('open');
            }
            function successMail() {
                console.log("Success register Callback effectué, présentement une fonctione vide");
                $("#newImageCmd").show();
                $("#mailCmd").hide();
                getImagesList(true);
            }
            function errorMail(status) {
                console.log("Error Register (Callback)")

                if(status == 480)
                    $("#errorMessage").text("Mauvais code de vérification.");

                $("#mailDlg").dialog('open');
                $("#errorDlg").dialog('open');
            }

            function loginCmd() {
                holdCheckETag = true;
                createMode = true;
                $("#loginDlg").dialog('option', 'title', "Connexion");
                $("#loginDlgOkBtn").text("Connexion");
                $("#log_email_input").val("");
                $("#log_mdp_input").val("");
                $("#loginDlg").dialog('open');
            }

            function loginFromForm() {
                let logininfo = {
                    Email: $("#log_email_input").val(),
                    Password: $("#log_mdp_input").val(),
                };
                return logininfo;
            }


            function logoutCmd() {
                holdCheckETag = true;
                let userId = getUserLogged();
                LOGOUT(userId, successLogout, error);
                holdCheckETag = false;
            }

            function logoutFromForm() {
                let logoutinfo = {
                    Email: $("#log_email_input").val(),
                    Password: $("#log_mdp_input").val(),
                };
                return logininfo;
            }





            function newImage() {
                holdCheckETag = true;
                createMode = true;
                resetimageForm();
                ImageUploader.imageRequired('image', true);
                $("#imageDlg").dialog('option', 'title', "Ajout d'image");
                $("#partager").prop( "checked", false);
                $("#imageDlgOkBtn").text("Ajouter");
                $("#imageDlg").dialog('open');
            }
            function editimage(e) {
                holdCheckETag = true;
                createMode = false;
                let imageIdToMod = e.target.getAttribute("imageid");
                GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
                holdCheckETag = true;
                ImageUploader.imageRequired('image', false);
                $("#imageDlg").dialog('option', 'title', "Modification d'image");
                $("#imageDlgOkBtn").text("Modifier");
                $("#imageDlg").dialog('open');
            }

            function imageSetDetails(image)
            {
                $("#date_details_input").html(convertToFrenchDate(parseInt(image.Date)));
                $("#title_details_input").html(image.Title);
                $("#description_details_input").html(image.Description);
                $("#image_details").html("<a href='"+image.OriginalURL+"' target='_blank'><img class='detailImage' src='" + image.OriginalURL + "' alt='image'></a>");          
                $("#creator_details_input").html(image.User.Name + "<img id='loginLogo' style='margin-left: 10px' width='30' height='30' src='" + image.User.AvatarURL + "' alt='image'>");            
            }
            
            function detailsimage(e) {
                holdCheckETag = true;
                createMode = false;

                let imageIdToMod = e.target.getAttribute("imageid");
                GET_ID(e.target.getAttribute("imageid"), imageSetDetails, error);
                holdCheckETag = true;
                ImageUploader.imageRequired('image', false);
                $("#imageDetailsDlg").dialog('option', 'title', "Détails de l'image");
                $("#imageDetailsDlgOkBtn").text("Description");
                $("#imageDetailsDlg").dialog('open');
            }

            function deleteimage(e) {
                holdCheckETag = true;
                imageIdToDelete = e.target.getAttribute("imageid")
                GET_ID(
                    imageIdToDelete,
                    image => {
                        $("#confirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title + "</b>?")
                    },
                    error
                );
                holdCheckETag = true;
                $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
                $("#confirmDeleteDlgOkBtn").text("Effacer");
                $("#confirmDeleteDlg").dialog('open');
            }
            function resetimageForm() {
                $("#Id_input").val("0");
                $("#GUID_input").val("");
                $("#image_userId_input").val("");
                
                $("#date_input").val(Date.now());
                $("#title_input").val("");
                $("#description_input").val("");
                ImageUploader.resetImage('image');
            }
            function deleteAccountCmd() {
                holdCheckETag = true;
                createMode = true;
                $("#deleteAccountDlg").dialog('option', 'title', "Suppression du compte");
                $("#deleteAccountDlgOkBtn").text("Supprimer");
                $("#deleteAccountDlg").dialog('open');
            }
            function goToAbout(){
                ABOUT();
            }
            function sortCmd(){
                if(sort == 'asc')
                    sort = 'desc';
                else
                    sort = 'asc';

                getImagesList(true);
            }

            function searchCmd(){

                userSelectSearch = $("#userSearch").val();
                //alert("searchcmd:"+userSelectSearch);
                textSearch = $("#search_input").val();
                getImagesList(true);
            }

            function imageFromForm() {
                if ($("#imageForm")[0].checkValidity()) {
                    let token = getAccessToken();
                    let userId = getUserLogged().Id;
                    let partager = 0;

                    if($("#partager").prop("checked"))
                    {
                        partager = 1;
                    }

                    let image = {
                        Id: parseInt($("#Id_input").val()),
                        GUID: $("#GUID_input").val(),
                        Shared: partager,
                        UserId: parseInt(userId),//$("#image_userId_input").val(),
                        Title: $("#title_input").val(),
                        Description: $("#description_input").val(),
                        ImageData: ImageUploader.getImageData('image'),
                        Date: parseInt(Date.now())
                    };
                    return image;
                } else {
                    $("#imageForm")[0].reportValidity()
                }
                return false;
            }
            function imageToForm(image) {
                $("#Id_input").val(image.Id);
                $("#GUID_input").val(image.GUID);
                // $("#image_userId_input").val(image.UserId);
                $("#image_userId_input").val(getUserLogged().Id);
               // $("#date_input").val(image.Date);
                $("#date_input").val(Date.now());
                $("#title_input").val(image.Title);
                $("#description_input").val(image.Description);
                $("#partager").prop( "checked", image.Shared);
                ImageUploader.setImage('image', image.OriginalURL);
            }

            function successRegister() {
                let logininfo = {
                    Email: registerEmail,
                    Password: registerPassword
                };

                LOGIN(logininfo, successLogin, errorLogin);
                console.log("Success register Callback effectué, présentement une fonctione vide");
            }
            function errorRegister(status) {
                console.log("Error Register (Callback)")
               // $("#errorMessage").text("ERROR " + status);

                if(status == '409')
                {
                        $("#errorMessage").text("Un compte a déjà été créé avec ce courriel");
                }

                $("#errorDlg").dialog('open');
            }
            function successEditUser() {
                console.log("Success EditUser Callback effectué");
                var user = getUserLogged();
                if (user != null) {
                    $("#loginUser").html(`<span id="userName">` + user.Name + `</span><img id="loginLogo" src="` + user.AvatarURL + `" alt="logo utilisateur" width="30" height="30">`);
                }
                if(user.VerifyCode == "verified"){
                        $("#newImageCmd").show();
                        $("#mailCmd").hide();
                    }
                    else{
                        $("#mailCmd").show();
                        $("#newImageCmd").hide();
                    }
            }
            function errorEditUser(status) {
                console.log("Error EditUser (Callback)")
                $("#errorMessage").text("ERROR " + status);
                $("#errorDlg").dialog('open');
            }
            function successLogin() {
                var user = getUserLogged();
                if (user != null) {
                    $("#loginUser").html(`<span id="userName">` + user.Name + `</span><img id="loginLogo" src="` + user.AvatarURL + `" alt="logo utilisateur" width="30" height="30">`);
                    $("#loginCmd").hide();
                    $("#registerCmd").hide();
                    $("#editProfileCmd").show();
                    $("#logoutCmd").show();
                    $("#deleteAccountCmd").show();
                    
                    if(user.VerifyCode == "verified"){
                        $("#newImageCmd").show();
                        $("#mailCmd").hide();
                    }
                    else{
                        $("#mailCmd").show();
                        $("#newImageCmd").hide();
                    }
                }
                getImagesList(true);
            }
            function errorLogin(status) {
                console.log("Erreur lors de la connexion --- Statut: " + status);
                if(status == 481)
                    $("#errorMessage").text("Courriel invalide");
                else if (status == 482)
                    $("#errorMessage").text("Mot de passe invalide");
                else
                    $("#errorMessage").text("Connexion échouée");
                $("#errorDlg").dialog('open');
            }
            function successLogout() {
                $("#loginUser").html("");
                getImagesList(true);
                $("#loginCmd").show();
                $("#registerCmd").show();
                $("#editProfileCmd").hide();
                $("#logoutCmd").hide();
                $("#newImageCmd").hide();
                $("#mailCmd").hide();
                $("#deleteAccountCmd").hide();
            }

            function successGetUser(profil){
                var user = getUserLogged();
                if (user != null) {
                    $("#loginUser").html(`<span id="userName">` + user.Name + `</span><img id="loginLogo" src="` + user.AvatarURL + `" alt="logo utilisateur" width="30" height="30">`);
                }
            }

            function init_UI() {
                $("#newImageCmd").click(newImage)
                $("#registerCmd").click(registerCmd)
                $("#editProfileCmd").click(editProfileCmd)
                $("#loginCmd").click(loginCmd)
                $("#logoutCmd").click(logoutCmd)
                $("#sort").click(sortCmd)
                $("#searchCmd").click(searchCmd)
                $("#mailCmd").click(mailCmd)
                $("#deleteAccountCmd").click(deleteAccountCmd)
                $("#Title_Logo").click(goToAbout);
                getListUser();

                var token = getAccessToken();
                let user = getUserLogged();
                if (user!=undefined){
                    GETUSERINFO(user.Id,successGetUser,error);
                    $("#loginCmd").hide();
                    $("#registerCmd").hide();
                    if(user.VerifyCode == "verified")
                        $("#mailCmd").hide();
                    else
                        $("#newImageCmd").hide();
                }
                else{
                    $("#editProfileCmd").hide();
                    $("#logoutCmd").hide();
                    $("#newImageCmd").hide();
                    $("#mailCmd").hide();
                    $("#deleteAccountCmd").hide();
                }

                $("#registerDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "registerDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let updatedUser = profileInfoFromForm();
                            let valid = ValidateAccount(registerMode, updatedUser.Password, $("#profile_cmdp_input").val(), updatedUser.Email, updatedUser.Name, updatedUser.ImageData);

                            if (registerMode && valid) {
                                console.log(updatedUser);

                                registerEmail = updatedUser.Email;
                                registerPassword = updatedUser.Password;

                                REGISTER(updatedUser, successRegister, errorRegister);
                                holdCheckETag = false;
                                $(this).dialog("close");
                                
                            }
                            else if(valid){
                                var currentUser = getUserLogged();
                                //Check if user wants to change his password and check if some requirements are met
                                if(
                                !(updatedUser.Password != String.empty /*&&
                                 updatedUser.OldPassword == currentUser.Password*/ &&
                                 updatedUser.Password == updatedUser.ConfirmPassword))
                                {
                                    updatedUser.Password = currentUser.Password;
                                }
                                //delete updatedUser.OldPassword;
                                delete updatedUser.ConfirmPassword;
                                MODIFY_USER_INFO(updatedUser, successEditUser, errorEditUser)

 
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }

                            ImageUploader.resetImage('avatarImage');
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#mailDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 540,
                    minWidth: 540,
                    maxWidth: 540,
                    height: 350,
                    minHeight: 350,
                    maxHeight: 350,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "mailDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let userId = getUserLogged().Id;
                            let verifyCode = $("#mailCode_input").val();
                            VERIFY_EMAIL(userId, verifyCode, successMail, errorMail)
                            $("#mailCode_input").val("");
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#loginDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 540,
                    minWidth: 540,
                    maxWidth: 540,
                    height: 350,
                    minHeight: 350,
                    maxHeight: 350,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "loginDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let login = loginFromForm();
                            if (login) {
                                LOGIN(login, successLogin, errorLogin);
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#imageDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "imageDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let image = imageFromForm();
                            console.log(image);
                            if (image) {
                                let valid = ValidateImage(image.Title, image.Description);

                                if(valid)
                                {
                                    if (createMode) {
                                        POST(image, getImagesList, error);
                                        $(".scrollContainer").scrollTop(0);
                                    }
                                    else {                                   
                                        EDIT_IMAGE(image, getImagesList, error);                                    
                                        // PUT(image, getImagesList, error);                                    
                                    }
                                    
                                    resetimageForm();
                                    holdCheckETag = false;
                                    $(this).dialog("close");
                                }                    
                            }
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });



                $("#imageDetailsDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [
                    {
                        text: "Fermer",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });




                $("#deleteAccountDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 400,
                    minWidth: 400,
                    maxWidth: 400,
                    height: 400,
                    minHeight: 400,
                    maxHeight: 400,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "deleteAccountDlgOkBtn",
                        text: "Supprimer",
                        click: function () {
                            var dialog = $(this);
                            let userId = getUserLogged().Id;
                            DELETE_USER(userId, deleteAccountSuccess, deleteAccountFailure);
                            function deleteAccountSuccess(ETag){
                                console.log("Success");
                                holdCheckETag = false;
                                // holdCheckETag = true;
                                // currentETag = ETag;
                                LOGOUT(userId, successLogout, error);
                                dialog.dialog("close");
                            }
                            function deleteAccountFailure(status){
                                console.log("error");
                                error(status);
                            }
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#confirmDeleteDlg").dialog({
                    title: "Attention!",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "confirmDeleteDlgOkBtn",
                        text: "Oui",
                        click: function () {
                            holdCheckETag = false;
                            if (imageIdToDelete)
                                DELETE(imageIdToDelete, getImagesList, error);
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#errorDlg").dialog({
                    title: "Erreur...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        text: "Fermer",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });

                $(".scrollContainer").scroll(function () {
                    if ($(".scrollContainer").scrollTop() + $(".scrollContainer").innerHeight() >= $("#imagesList").height()) {
                        getImagesList(false);
                    }
                });
            }
        </script>

    </body>

</html>
